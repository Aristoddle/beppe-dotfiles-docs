# System Health Check Workflow

Comprehensive health audit combining configuration and security validation.

## Metadata

```yaml
workflow: system-health-check
agents:
  - dotfiles-maintainer
  - security-scanner
execution: parallel
estimated_time: 15s
priority: high
```

## Purpose

Perform a complete system health audit by running both configuration health checks and security scans in parallel, then aggregating results into a unified report.

## Workflow Steps

### Phase 1: Parallel Agent Execution (10s)

Launch both agents simultaneously for maximum efficiency:

**Agent 1: dotfiles-maintainer**
- Check for broken symlinks
- Verify all tools from TOOLS.md installed
- Validate runtime versions (mise, pyenv)
- Detect orphaned configurations
- Measure shell startup performance
- Check for available package updates
- Validate chezmoi sync status

**Agent 2: security-scanner**
- Scan for hardcoded secrets
- Audit file permissions (.ssh/, .aws/, etc.)
- Validate .chezmoiignore coverage
- Check shell history for exposed secrets
- Scan git commits for secrets
- Detect insecure configurations

### Phase 2: Result Aggregation (3s)

Combine outputs from both agents:
- Merge issue lists (critical, warnings, info)
- Deduplicate findings
- Prioritize by severity
- Cross-reference related issues

### Phase 3: Report Generation (2s)

Generate unified health report:
- Executive summary
- Critical issues (immediate action required)
- Warnings (should fix soon)
- Best practices status
- Recommended action plan

## Execution

### Via Workflow Launcher
```bash
# Run from command line
workflow health

# Or explicitly
workflow system-health-check
```

### Via Slash Command
```bash
# In Claude Code
/agent dotfiles-maintainer, security-scanner
```

### Manual Agent Launch
```bash
# Launch agents individually (not parallel)
/agent dotfiles-maintainer
/agent security-scanner
```

## Expected Output

### Terminal Output (Live)
```
üîÑ Running system health check...

Launching agents in parallel:
  ‚îú‚îÄ dotfiles-maintainer... ‚úì (8.2s)
  ‚îî‚îÄ security-scanner...    ‚úì (7.5s)

Aggregating results... ‚úì (1.1s)
Generating report...   ‚úì (0.8s)

‚úÖ Health check complete (12.1s total)

üìä Summary:
  Critical Issues: 0
  Warnings:        3
  Tools Missing:   1
  Security Risks:  0

Report saved: ~/.cache/system-health-report.md
```

### Unified Report Structure

```markdown
# System Health Report
Generated: 2025-10-31 14:30:15
Agents: dotfiles-maintainer + security-scanner

## üéØ Executive Summary

**Overall Health**: Good (85/100)
**Critical Issues**: 0
**Warnings**: 3
**Security Status**: ‚úÖ Secure

System is healthy with minor maintenance recommended.

---

## üî¥ Critical Issues (0)

No critical issues detected.

---

## ‚ö†Ô∏è Warnings (3)

### Configuration Warnings (2)

**W-CFG-001: Outdated Package**
- Component: mise/node
- Current: 22.19.0
- Available: 22.20.0
- Impact: Missing security patches
- Fix: `mise upgrade node`

**W-CFG-002: Orphaned Config**
- Path: ~/.config/defunct-tool/
- Issue: Tool no longer installed
- Impact: Clutter, potential confusion
- Fix: `rm -rf ~/.config/defunct-tool/`

### Security Warnings (1)

**W-SEC-001: File Permission**
- File: ~/.ssh/config
- Current: 644 (world-readable)
- Required: 600
- Impact: SSH config exposed to other users
- Fix: `chmod 600 ~/.ssh/config`

---

## üü¢ Health Indicators

### Configuration ‚úÖ
- ‚úÖ All core config files present
- ‚úÖ 41/42 tools installed (lazydocker missing)
- ‚úÖ Shell startup: 152ms (target: <200ms)
- ‚úÖ chezmoi: synced with origin/main

### Security ‚úÖ
- ‚úÖ No hardcoded secrets detected
- ‚úÖ 1Password integration active
- ‚úÖ .chezmoiignore properly configured
- ‚úÖ No secrets in git history
- ‚ö†Ô∏è 1 file permission issue (see above)

---

## üìä Detailed Metrics

### System Configuration
- Managed files: 83
- Total functions: 23
- Active plugins: 12
- Shell startup: 152ms
- Last sync: 4 hours ago

### Security Posture
- Files scanned: 83
- Secrets found: 0
- Permission issues: 1
- History leaks: 0
- Git history clean: ‚úì

---

## üîß Recommended Action Plan

### Immediate (None)
No critical issues require immediate action.

### Soon (3 items)
1. Fix ~/.ssh/config permissions: `chmod 600 ~/.ssh/config`
2. Update node runtime: `mise upgrade node`
3. Remove orphaned config: `rm -rf ~/.config/defunct-tool/`

### Optional
4. Install lazydocker: `brew install lazydocker`
5. Run performance audit to optimize startup time

---

## üìÖ Next Health Check

Recommended: Weekly
Next scheduled: 2025-11-07 (7 days)

---

Generated by: dotfiles-maintainer v1.0.0 + security-scanner v1.0.0
Report ID: health-20251031-143015
```

## Success Criteria

- ‚úÖ Both agents complete within 15 seconds
- ‚úÖ All issues categorized by severity
- ‚úÖ No duplicate findings
- ‚úÖ Actionable fix commands provided
- ‚úÖ Security + configuration unified view
- ‚úÖ Report stored for historical tracking

## Automation

### Weekly Cron Job
```bash
# Add to crontab
0 9 * * 1 /usr/local/bin/workflow health > ~/.cache/weekly-health.log 2>&1

# Or via launchd (macOS)
# ~/Library/LaunchAgents/com.beppe.health-check.plist
```

### Startup Hook
```bash
# Add to ~/.config/zsh/.zshrc (optional)
# Run health check if > 7 days since last run
HEALTH_CHECK_FILE=~/.cache/system-health-report.md
if [[ -f "$HEALTH_CHECK_FILE" ]]; then
  DAYS_OLD=$(( ($(date +%s) - $(stat -f %m "$HEALTH_CHECK_FILE")) / 86400 ))
  if (( DAYS_OLD > 7 )); then
    echo "‚ö†Ô∏è  Health check overdue (${DAYS_OLD} days). Run: workflow health"
  fi
fi
```

## Historical Tracking

### Trend Analysis
```bash
# Compare health scores over time
tail -20 ~/.cache/health-history.log

# Format:
# 2025-10-24 | 92 | 0 critical, 1 warning
# 2025-10-31 | 85 | 0 critical, 3 warnings

# Alert on declining trend
```

## Integration Points

- **dotfiles-maintainer**: Configuration health
- **security-scanner**: Security posture
- **Notification system**: Alert on critical issues
- **Git hooks**: Run before major deployments

---

**Status**: Production Ready
**Last Updated**: 2025-10-31
**Workflow ID**: health-check-v1
