# Agent Development Guide

Standards and best practices for creating Claude Code agents in beppe-system-bootstrap.

## Agent Philosophy

**Agents are autonomous specialists** that perform deep analysis and maintenance tasks:
- **Focused scope**: One clear purpose per agent
- **Self-contained**: All logic and documentation in one file
- **Observable**: Clear inputs, outputs, and success criteria
- **Composable**: Can be orchestrated in multi-agent workflows

**Agents vs Skills**:
- **Skills** (`~/.claude/skills/`): Passive guidelines, always active, shape how Claude thinks
- **Agents** (`~/.claude/agents/`): Active workers, invoked on-demand, perform specific tasks

## Agent Structure

### Required Sections

Every agent MUST include:

```markdown
# Agent Name

Brief description (one sentence).

## Metadata

```yaml
name: agent-name
version: 1.0.0
description: Detailed description of what this agent does
category: maintenance | security | performance | quality-assurance
execution: autonomous | on-demand
priority: critical | high | medium | low
allowed-tools:
  - Bash
  - Read
  - Grep
  - Write
```

## Capabilities

### 1. First Capability
Detailed description with code examples

### 2. Second Capability
Detailed description with code examples

## Output Format

### Report Structure
Example output with markdown formatting

## Execution Triggers

When and how to run this agent

## Integration Points

How this agent works with others

## Configuration

Optional settings

## Success Criteria

How to measure agent effectiveness

---

**Status**: Production Ready | Beta | Experimental
**Last Updated**: YYYY-MM-DD
**Maintainer**: Automated via Claude Code
```

### Metadata Guidelines

**name**: Kebab-case, descriptive (`dotfiles-maintainer`, not `DM`)

**version**: Semantic versioning (1.0.0 = production, 0.x.x = beta)

**category**:
- `maintenance`: System health, updates, cleanup
- `security`: Secret scanning, permissions, vulnerabilities
- `performance`: Profiling, optimization, benchmarking
- `quality-assurance`: Testing, validation, documentation

**execution**:
- `autonomous`: Runs automatically on schedule
- `on-demand`: Invoked manually by user or workflow

**priority**:
- `critical`: Blocks operations if fails (e.g., pre-commit gate)
- `high`: Should run regularly (e.g., health checks)
- `medium`: Run occasionally (e.g., performance audits)
- `low`: Optional, informational

**allowed-tools**: List of Claude Code tools this agent may use
- Prefer: `Read`, `Grep`, `Bash` (read-only when possible)
- Use cautiously: `Write`, `Edit` (modify files)
- Avoid: `WebFetch`, `WebSearch` (network dependency)

## Capabilities Section

### Structure
```markdown
## Capabilities

### 1. Capability Name

**What it does**: One sentence description

**How it works**:
```bash
# Executable code examples
command --example
```

**Edge cases**:
- Case 1: Handling
- Case 2: Handling

**Output**: What this capability produces
```

### Best Practices

1. **Show, don't tell**: Include runnable code examples
2. **Cover edge cases**: Invalid input, missing tools, permissions
3. **Explain patterns**: Why this approach, not just what it does
4. **Provide context**: When to use this capability

### Code Quality

**Shell commands**:
```bash
# ‚úÖ Good: Explicit, readable
if [[ ! -f "$file" ]]; then
  echo "Error: File not found: $file" >&2
  return 1
fi

# ‚ùå Bad: Cryptic, no error handling
[ -f $file ] || exit 1
```

**Error handling**:
```bash
# Always check tool availability
if ! type jq &>/dev/null; then
  echo "jq not installed, falling back to python" >&2
  python -m json.tool
fi
```

## Output Format Section

### Report Structure

Agents MUST generate consistent, parseable reports:

```markdown
# Agent Name Report
Generated: YYYY-MM-DD HH:MM:SS

## üéØ Summary
Key findings in 2-3 sentences

## üî¥ Critical Issues (N)
Severity: Immediate action required

### C-001: Issue Title
**Component**: What's affected
**Issue**: Specific problem
**Impact**: Why it matters
**Fix**: Exact command to run

## ‚ö†Ô∏è Warnings (N)
Severity: Should fix soon

### W-001: Warning Title
[Same structure as critical]

## üü¢ Best Practices (N)
What's working well

## üîß Recommended Actions
Prioritized list with commands

---

Generated by: agent-name v1.0.0
Report ID: agent-timestamp
```

### Report Guidelines

1. **Use emojis sparingly**: Only for severity levels (üî¥‚ö†Ô∏èüü¢)
2. **Provide exact commands**: Copy-pastable fixes
3. **Include context**: Why this is an issue, not just what
4. **Prioritize clearly**: Critical ‚Üí Warnings ‚Üí Info
5. **Add metadata**: Timestamp, version, report ID for tracking

### Output Files

Standard locations:
```bash
~/.cache/agent-name-report.md           # Latest full report
~/.cache/agent-name-summary.txt         # One-line summary for scripts
~/.cache/agent-name-history.log         # Historical results
```

## Integration Points

### Workflow Composition

Agents should document how they work with others:

```markdown
## Integration Points

**Works With:**
- `other-agent` - How they coordinate
- `workflow-name` - Which workflows use this agent

**Outputs:**
- `~/.cache/file.md` - What it produces
- Exit code: 0 (success), 1 (warnings), 2 (critical)

**Inputs** (if any):
- Environment variables
- Config files
- Previous agent outputs
```

### Parallel vs Sequential

**Parallel** (independent agents):
```yaml
workflow: health-check
agents:
  - dotfiles-maintainer  # Doesn't depend on security-scanner
  - security-scanner     # Doesn't depend on dotfiles-maintainer
execution: parallel
```

**Sequential** (dependent agents):
```yaml
workflow: performance-optimization
agents:
  - zsh-performance-auditor  # Must run first (generates data)
  - dotfiles-maintainer      # Uses data from auditor
execution: sequential
```

## Configuration

### Optional Settings File

If agent has configurable behavior:

```bash
# ~/.config/agent-name.conf
OPTION_ONE=value
OPTION_TWO=value

# Document in agent:
## Configuration

**Settings** (in `~/.config/agent-name.conf`):
```bash
# Option description
OPTION_ONE=default_value

# Another option
OPTION_TWO=default_value
```

### Environment Variables

Prefer config files over environment variables for persistence.

Use env vars for:
- Overrides: `AGENT_NAME_DEBUG=1 workflow health`
- CI/CD: `FAIL_ON_WARNINGS=true`
- One-time flags: `AGENT_NAME_VERBOSE=1`

## Testing Agents

### Manual Testing

```bash
# 1. Test agent execution
/agent agent-name

# 2. Verify report generation
ls -l ~/.cache/agent-name-report.md

# 3. Check exit code
echo $?  # 0 = success, 1 = warnings, 2 = critical

# 4. Validate output format
head -20 ~/.cache/agent-name-report.md
```

### Test Cases

Document expected behavior:

```markdown
## Test Cases

1. **Normal operation**
   - Input: Standard system state
   - Expected: Clean report, exit 0

2. **With warnings**
   - Input: Outdated packages detected
   - Expected: Warning in report, exit 1

3. **With critical issues**
   - Input: Security violation found
   - Expected: Critical in report, exit 2

4. **Tool missing**
   - Input: Required tool not installed
   - Expected: Graceful degradation, warning

5. **Permission denied**
   - Input: Cannot read protected file
   - Expected: Skip gracefully, note in report
```

## Versioning

### Version Numbers

- `1.0.0`: Production-ready, stable API
- `0.x.x`: Beta, may change
- `x.y.0`: New capability added
- `x.y.z`: Bug fix, no new features

### Changelog

Maintain in agent file:

```markdown
## Version History

### 1.1.0 (2025-11-15)
- Added capability: xyz
- Improved performance by 20%

### 1.0.0 (2025-10-31)
- Initial production release
- All capabilities tested
```

## Deployment

### Adding New Agent

1. **Create agent file**: `dot_claude/agents/agent-name.md`
2. **Follow template**: Use `dot_claude/agents/TEMPLATE.md`
3. **Test thoroughly**: Manual testing + edge cases
4. **Document in README**: Add to agent list
5. **Create workflow** (if needed): `docs/workflows/workflow-name.md`
6. **Update this guide** (if introducing patterns)

### Updating Existing Agent

1. **Increment version**: Update metadata
2. **Add to changelog**: Document changes
3. **Test changes**: Ensure backward compatibility
4. **Update workflows**: If integration changes
5. **Commit**: `git commit -m "feat(agent): description"`

## Common Patterns

### File Scanning

```bash
# Scan for pattern in tracked files
cd ~/.local/share/chezmoi
git ls-files | while read file; do
  if grep -q "PATTERN" "$file"; then
    echo "Found in: $file"
  fi
done

# Respect .chezmoiignore
git ls-files | grep -v -f .chezmoiignore
```

### Tool Version Checking

```bash
# Get version safely
if type tool &>/dev/null; then
  version=$(tool --version 2>/dev/null | head -1 | awk '{print $NF}')
  echo "tool: $version"
else
  echo "tool: not installed"
fi
```

### Exit Codes

```bash
# Standardized exit codes
exit 0  # Success, no issues
exit 1  # Success with warnings
exit 2  # Critical issues found
exit 3  # Agent error (tool missing, permission denied)
```

### Report Generation

```bash
# Atomic report writing
REPORT_FILE=~/.cache/agent-name-report.md
TEMP_REPORT=$(mktemp)

# Write to temp file
cat > "$TEMP_REPORT" << 'EOF'
Report content here
EOF

# Atomic move to final location
mv "$TEMP_REPORT" "$REPORT_FILE"
```

## Troubleshooting

### Agent Not Found
```bash
# Check agent file exists
ls ~/.claude/agents/agent-name.md

# Verify YAML metadata
head -20 ~/.claude/agents/agent-name.md
```

### Permission Errors
```bash
# Ensure agent has necessary permissions
# Add to allowed-tools in metadata
allowed-tools:
  - Bash
  - Read  # File reading
  - Write # File writing (use cautiously)
```

### Timeout Issues
```bash
# Long-running agents should show progress
echo "Step 1/5: Scanning files..." >&2
# ... work ...
echo "Step 2/5: Analyzing data..." >&2
```

---

## Using Agents & Workflows

### Multi-Agent Workflows

The system includes 3 pre-built workflows that orchestrate multiple agents:

#### Health Check Workflow
```bash
# Run system health check (parallel: maintainer + scanner)
workflow health

# Generated report:
cat ~/.cache/system-health-report.md
```

**What it does**:
- Runs `dotfiles-maintainer` and `security-scanner` in parallel
- Checks system health, tool availability, startup time
- Scans for hardcoded secrets and permission issues
- Generates combined health report

**Use when**:
- Setting up new machine
- After major system changes
- Weekly health checks
- Before committing significant changes

#### Pre-Commit Validation Workflow
```bash
# Run pre-commit validation (parallel: test-validator + doc-synchronizer)
workflow pre-commit

# View validation report:
cat ~/.cache/pre-commit-validation-report.md
```

**What it does**:
- Runs `test-validator` and `doc-synchronizer` in parallel
- Tests all shell functions for correctness
- Validates documentation accuracy and completeness
- Returns PASS/FAIL gate decision

**Use when**:
- Before committing code changes
- As git pre-commit hook (recommended)
- After modifying shell functions
- After updating documentation

#### Performance Audit Workflow
```bash
# Run performance optimization (sequential: auditor ‚Üí maintainer)
workflow performance

# View optimization plan:
cat ~/.cache/performance-optimization-plan.md
```

**What it does**:
- Phase 1: `zsh-performance-auditor` profiles shell startup
- Phase 2: `dotfiles-maintainer` gathers system context
- Phase 3: Generates actionable optimization recommendations

**Use when**:
- Shell startup feels slow
- After adding new plugins
- Periodic performance review (monthly)
- Optimizing for low-spec machines

### Direct Agent Invocation (Future)

When direct agent invocation is implemented:

```bash
# Invoke specific agent with custom prompt
claude-code /agent dotfiles-maintainer "Check if all tools are up to date"

# Run with debug output
DOTFILES_MAINTAINER_DEBUG=1 claude-code /agent dotfiles-maintainer "Audit system"

# Chain multiple agents
claude-code /agent security-scanner "Scan for secrets" && \
claude-code /agent dotfiles-maintainer "Generate health report"
```

### Workflow Options

```bash
# Quiet mode (suppresses output, useful for scripts)
workflow health --quiet

# Help for specific workflow
workflow health --help

# List all workflows
workflow list
```

### Example Output

**Health Check Report** (excerpt):
```markdown
# System Health Report
Generated: 2025-10-31 14:30:00

## üéØ Executive Summary
**Overall Health**: Good (85/100)
**Critical Issues**: 0
**Warnings**: 2

## ‚ö†Ô∏è Warnings
- mise: Update available (1.48.0 ‚Üí 1.50.2)
- fzf: Completion files out of date

## üü¢ Health Indicators
### Configuration ‚úÖ
- ‚úÖ All core config files present
- ‚úÖ Shell startup: 0.42s (target: <0.5s)
```

**Pre-Commit Report** (excerpt):
```markdown
# Pre-Commit Validation Report

## üéØ Gate Decision: PASS ‚úÖ
All validation checks passed. Safe to commit.

## ‚úÖ Test Validation
**Coverage**: 23/23 functions tested (100%)
**Pass Rate**: 100%

## ‚úÖ Documentation Validation
**Health Score**: 95/100
- 2 TODO items found in docs/
- All code references valid
```

---

## Examples

See existing agents:
- `dotfiles-maintainer.md` - Comprehensive maintenance agent
- `security-scanner.md` - Security-focused agent with strict checks
- `zsh-performance-auditor.md` - Performance analysis with benchmarking
- `test-validator.md` - Test execution and validation
- `doc-synchronizer.md` - Documentation synchronization

---

**Last Updated**: 2025-10-31
**Maintained By**: Beppe System Bootstrap Project
